databaseChangeLog:
  - changeSet:
      id: 16-install-btree-gist-extension
      author: db_architect
      changes:
        - sql:

            sql: CREATE EXTENSION IF NOT EXISTS btree_gist;

  - changeSet:
      id: 17-add-exclusion-constraint-to-groups
      author: db_architect
      changes:
        - sql:
            sql: |
              ALTER TABLE groups
              ADD CONSTRAINT groups_room_schedule_overlap_excl
              EXCLUDE USING GIST (
                room_id WITH =,
                schedule WITH =,
                daterange(start_date, end_date, '[]') WITH &&
              )
              WHERE (deleted = false);

  - changeSet:
      id: 005-create-get-teacher-id-for-lesson-function
      author: db_architect
      changes:
        - sql:
            sql: |
              CREATE OR REPLACE FUNCTION get_teacher_id_for_lesson(p_group_id BIGINT)
              RETURNS BIGINT AS $$
              DECLARE
                v_teacher_id BIGINT;
              BEGIN
                SELECT teacher_id INTO v_teacher_id FROM groups WHERE id = p_group_id;
                RETURN v_teacher_id;
              END;
              $$ LANGUAGE plpgsql IMMUTABLE;

  - changeSet:
      id: 005-add-teacher-exclusion-constraint-to-lessons
      author: db_architect
      changes:
        - sql:
            sql: |
              ALTER TABLE lesson
              ADD CONSTRAINT lesson_teacher_time_overlap_excl
              EXCLUDE USING GIST (
                get_teacher_id_for_lesson(group_id) WITH =,
                tsrange(
                  (date + start_time),
                  (date + end_time),
                  '[)'
                ) WITH &&
              )
              WHERE (deleted = false);